\section{Operational Semantics}

\input{opsem}

\begin{definition} [\bfseries Semantic Ancestor]
Version $v_1$ is a semantic ancestor of version $v_2$ under a history
$H$ (written $\under{H}{v_1 \sempreceq v_2}$) if and only if:
\begin{itemize}
  \item There exists a branch $b$ in $H$ (i.e., $\exists(t\in
  dom(H)).\,H(t) = b$) in which $v_2$ immediately succeeds
  $v_1$, but $v_2$ is not a result of a merge operation (i.e.,
  $v_2$'s tag is not \C{MERGE}), or
  \item There exists a branch $b$ in $H$, such that $b = (v_2, 
  \C{FORK}\; (v_1,f_1)::b_1)::b'$, for some $f_1$, $b_1$ and $b'$, or
  \item There exists a branch $b$ in $H$ that contains
  $(v_2, \C{MERGE}\;(v_1,f_1)::b_1)$, for some $f_1$ and $b_1$, or
  \item $v_1 = v_2$, or $v_1$ is transitively a semantic ancestor of
  $v_2$, i.e., $\exists v.~ \under{H}{v_1 \sempreceq v} \conj
  \under{H}{v \sempreceq v}$ 
\end{itemize}
\end{definition}

\begin{definition} [\bfseries Least Common Semantic Ancestor]
Version $v$ is said to be a common semantic ancestor of versions $v_1$
and $v_2$ under $H$ iff $\under{H}{v \sempreceq v_1}$ and $\under{H}{v
\sempreceq v_2}$. It is said to be the least common semantic ancestor
(LCSA) of $v_1$ and $v_2$, iff there does not exist a $v'$ such that
$\under{H}{v' \sempreceq v_1}$ and $\under{H}{v' \sempreceq v_2}$ and
$\under{H}{v \preceq v'}$.
\end{definition}

\begin{lemma}
Semantic ancestor relation is a semi-lattice. For any two versions
$v_1$ and $v_2$, there exists a unique LCSA, which is their join ($v_1
\sqcup v_2$).
\end{lemma}

\begin{definition} [\bfseries Semantic Origin]
Version $v_o$ is said to be the semantic origin of a branch $b$ under
a history $H$ iff:
\begin{itemize}
  \item $v_o$ lies outside branch $b$, and
  \item $v_o$ is a semantic ancestor of the latest version ($v$) of $b$
  under $H$, and
  \item $v_o$ is the least such version, i.e., every other semantic
  ancestor ($v_o'$) of $v$ such that $v_o' \not\in b$ is also a
  semantic ancestor of $v_o$.
\end{itemize}
\end{definition}

\begin{definition} [\bfseries Mergeability]
Versions $v_1$ and $v_2$ are mergeable under $H$ iff their least
common ancestor is also their semantic ancestor. Branches $b_1$ and
$b_2$ are mergeable under $H$ iff their latest versions are mergeable
under $H$.
\end{definition}

\begin{definition} [\bfseries Ancestor]
Version $v_1$ is a syntactic ancestor (or simply, ancestor) of
version $v_2$ under a history $H$ (written $\under{H}{v_1 \preceq
v_2}$) if and only if:
\begin{itemize}
  \item $v_1$ is a semantic ancestor of $v_2$, or
  \item $v_2$ is a result of a merge, and $v_2$ immediately succeeds
  $v_1$ in some branch $b$ in $H$, or
  \item $v_1 = v_2$ or $v_1$ is transitively an ancestor of $v_2$.
\end{itemize}
\end{definition}

\begin{definition} [\bfseries Least Common Ancestor]
Version $v$ is said to be a common ancestor of versions $v_1$ and
$v_2$ under $H$ iff $\under{H}{v \preceq v_1}$ and $\under{H}{v
\preceq v_2}$. It is said to be the least common ancestor (LCA) of
$v_1$ and $v_2$, iff there does not exist a $v'$ such that
$\under{H}{v' \preceq v_1}$ and $\under{H}{v' \preceq v_2}$ and
$\under{H}{v \preceq v'}$.
\end{definition}



\begin{theorem} [\bfseries Unique LCA]
Every pair of versions $v_1$ and $v_2$ in the history $H$ generated by
the abstract machine of Fig.~\ref{fig:opsem} have a unique least
common ancestor. More precisely, if every pair of versions in the
initial history $H$ have a unique LCA, and if the abstract machine
takes $H$ to $H'$, then every pair of versions in the final history
$H'$ also have a unique LCA.
\end{theorem}
\begin{proof}
By case analysis on the step relation. The \rulelabel{E-Run} case is
trivial. The \rulelabel{E-Push} case creates a new version ($v$) with
\C{PUSH} tag at the end of a branch. Let $v_1$ be the previous version
on the branch, and let $v_2$ be any other version. The premise is that
$v_1$ and $v_2$ have a unique LCA $v_0$. Observe that if $v_0 \neq
v_1$, then LCA of $v$ and $v_2$ must also be an LCA of $v_1$ and
$v_2$, hence LCA of $v$ and $v_2$ is unique. If $v_0 = v_1$, then LCA
of $v$ and $v_2$ is $v_1$, hence unique. Thus, uniqueness of LCA is
preserved. The reasoning for \rulelabel{E-Fork} is similar. The 
\rulelabel{E-Pull} case is trivial. The \rulelabel{E-Pull-Wait} case
is where the merge happens. 
\end{proof}
