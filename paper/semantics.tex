\section{Operational Semantics}

\input{opsem}

\begin{definition} [\bfseries Ancestor]
Version $v_1$ is a ancestor of version $v_2$ under a history
$H$ (written $\under{H}{v_1 \preceq v_2}$) if and only if:
\begin{itemize}
  \item There exists a branch $b$ in $H$ (i.e., $\exists(t\in
  dom(H)).\,H(t) = b$) in which $v_2$ immediately succeeds
  $v_1$, or
  \item There exists a branch $b$ in $H$, such that $b = (v_2, 
  \C{FORK}\; (v_1,f_1)::b_1)::b'$, for some $f_1$, $b_1$ and $b'$, or
  \item There exists a branch $b$ in $H$ that contains
  $(v_2, \C{MERGE}\;(v_1,f_1)::b_1)$, for some $f_1$ and $b_1$, or
  \item $v_1 = v_2$, or $v_1$ is transitively a ancestor of
  $v_2$, i.e., $\exists v.~ \under{H}{v_1 \preceq v} \conj
  \under{H}{v \preceq v}$ 
\end{itemize}
\end{definition}

\begin{definition} [\bfseries Least Common Ancestor]
Version $v$ is said to be a common ancestor of versions $v_1$
and $v_2$ under $H$ iff $\under{H}{v \preceq v_1}$ and $\under{H}{v
\preceq v_2}$. It is said to be the least common ancestor
(LCA) of $v_1$ and $v_2$, iff there does not exist a $v'$ such that
$\under{H}{v' \preceq v_1}$ and $\under{H}{v' \preceq v_2}$ and
$\under{H}{v \preceq v'}$.
\end{definition}

\begin{definition} [\bfseries Internal and External Ancestors]
Given a branch $b$ and a version $v\in b$, an internal ancestor of $v$
is an ancestor from the same branch $b$. An external ancestor of $v$
is an ancestor from a different branch $b'\neq b$. 
\end{definition}

\begin{definition} [\bfseries Least Internal and External Ancestors]
Given a branch $b$ and a version $v\in b$, least internal ancestor is
the immediate ancestor version ($v_i$) of $v$ on $b$. Least external
ancestor ($v_o$) is an external ancestor of $v$ that is not an
ancestor of any other external ancestor of $v$. That is,
$\under{H}{v_o \preceq v}$, and there does not exist a $v_o' \not\in
b$ such that $\under{H}{v_o' \preceq v}$ and $\under{H}{v_o \preceq
v_o'}$. 
% We lift the definition to the level of branches; $v_o$ is an
% external locus of a branch $b$ iff it is an external locus of its
% latest version.
\end{definition}

Note that all branches (except $H(t_{\top})$) begin with a \C{FORK}
tag, hence every version has at least one least external ancestor. We
later prove that in the histories generated by the rules in
Fig.~\ref{fig:opsem}, each version has exactly one least external
ancestor. We call the unique least external ancestor of a version as
its \emph{external locus}. Least internal ancestor, by definition, is
unique, which we sometimes call \emph{internal locus}.

\begin{definition} [\bfseries Mergeability]
Given a history $H$, a version $v_1$ and a version $v_2$ that is not
an ancestor of $v_1$ under $H$, $v_2$ is mergeable into $v_1$ (denoted
$\under{H}{v_2 \mbleto v_1}$) iff $v_1$'s external locus is an
ancestor of $v_2$.
\end{definition}

\begin{lemma} [\bfseries Unique External Locus]
Every version $v$ (except the \C{INIT} version) in the history $H$
generated by the rules in Fig.~\ref{fig:opsem} has a unique external
locus.
\end{lemma}
\begin{proof}
By case analysis on the reduction relation. In each case, we assume
that the unique external locus property holds for the initial history,
and prove that it holds for the final history.

In \rulelabel{E-Run} case, initial version is the unique external locus of
the new version on the new branch $H(t)$. In \rulelabel{E-Fork} case,
which creates the branch $H(t')$ by forking from $H(t)$, the latest
version on $H(t)$ is the external locus of the first version on
$H(t)$. In \rulelabel{E-Push} case, the version on $H(t)$ has the same
external locus as the previous latest version, which, premise says, is
unique. No new version is created in \rulelabel{E-Pull}. In
\rulelabel{E-Pull-Wait}, new version is created by merging the latest
version ($v'$) on $H(t')$ into the latest version $v$ on $H(t)$.
Premise says that $v$ has a unique external locus (call it $v_o$). The
new version $v_m$ inherits $v_o$ as a least external ancestor, and
also has $v'$ as another least external ancestor. However, since
$\under{H}{v' \mbleto v}$, we have $\under{H}{v_o \preceq v'}$, we
have $v'$ as the the external locus.
\qed
\end{proof}

%% If we are allowed to merge earlier versions on branches, then we
%% have a possibility of utmost two LCAs.

\begin{theorem} [\bfseries Unique LCA]
Every pair of versions $v_1$ and $v_2$ in the history $H$ generated by
the rules in Fig.~\ref{fig:opsem} have a unique least
common ancestor. 
\end{theorem}
\begin{proof}
By case analysis on the step relation. In each case, we assume that
the unique LCA property holds for the initial history, and prove that
it holds for the final history.

The \rulelabel{E-Run} case is trivial. The \rulelabel{E-Push} case
creates a new version ($v$) with \C{PUSH} tag at the end of a branch.
Let $v_1$ be the previous version on the branch, and let $v_2$ be any
other version. The premise is that $v_1$ and $v_2$ have a unique LCA
$v_0$. Observe that $v$'s internal locus is $v_1$ and its external
locus is same as that of $v_1$. Hence, all ancestors of $v_1$
(including itself) are also ancestors of $v$. Moreover, $v$ has no new
ancestors except itself, which is the latest version being added.
Hence, any common ancestor of $v_1$ and $v_2$ is also a common
ancestor of $v$ and $v_2$, while there cannot be new common ancestors.
Hence LCA of $v$ and $v_2$ is unique. The reasoning for
\rulelabel{E-Fork} is similar. The \rulelabel{E-Pull} case is trivial. 

The \rulelabel{E-Pull-Wait} case is where the merge happens. Version
$v_m$ is merging into version $v$ to produce the next version $v_m$.
Let $v_2$ be any version. From premise, we know that $v$ and $v_2$
have a unique LCA (call it $v_0$), and $v'$ and $v_2$ have a unique
LCA (call it $v_1$). But, we know that $v_2$ has a unique external
locus, which leads to the following cases:
\begin{itemize}
  \item Both $v_0$ and $v_1$ are external ancestors of $v_2$. Hence,
  $\under{H}{v_0 \preceq v_1} \disj \under{H}{v_1 \preceq v_0}$.
  Since\under{H}{v_0 \preceq v_m} \disj \under{H}{v_1 \preceq v_m}, 
  $v_2$ and $v_m$ have a unique LCA.

  \item $v_0$ is an internal ancestor of $v_2$, hence an external
  ancestor of $v$, hence an external ancestor of $v_m$. $v_1$ is
  an ancestor of $v'$, hence also an external ancestor of $v_m$. 
\end{itemize}


As proved
before, the merged version ($v_m$) has a unique external locus, which
is the merging version ($v'$).
\end{proof}

