\section{Operational Semantics}

\input{opsem}

\begin{definition} [\bfseries Ancestor]
Version $v_1$ is a ancestor of version $v_2$ under a history
$H$ (written $\under{H}{v_1 \preceq v_2}$) if and only if:
\begin{itemize}
  \item There exists a branch $b$ in $H$ (i.e., $\exists(t\in
  dom(H)).\,H(t) = b$) in which $v_2$ immediately succeeds
  $v_1$, or
  \item There exists a branch $b$ in $H$, such that $b = (v_2, 
  \C{FORK}\; (v_1,f_1)::b_1)::b'$, for some $f_1$, $b_1$ and $b'$, or
  \item There exists a branch $b$ in $H$ that contains
  $(v_2, \C{MERGE}\;(v_1,f_1)::b_1)$, for some $f_1$ and $b_1$, or
  \item $v_1 = v_2$, or $v_1$ is transitively a ancestor of
  $v_2$, i.e., $\exists v.~ \under{H}{v_1 \preceq v} \conj
  \under{H}{v \preceq v}$ 
\end{itemize}
\end{definition}

\begin{definition} [\bfseries Least Common Ancestor]
Version $v$ is said to be a common ancestor of versions $v_1$
and $v_2$ under $H$ iff $\under{H}{v \preceq v_1}$ and $\under{H}{v
\preceq v_2}$. It is said to be the least common ancestor
(LCA) of $v_1$ and $v_2$, iff there does not exist a $v'$ such that
$\under{H}{v' \preceq v_1}$ and $\under{H}{v' \preceq v_2}$ and
$\under{H}{v \preceq v'}$.
\end{definition}

\begin{definition} [\bfseries External Locus]
Given a branch $b$ and a version $v\in b$, a version $v_o \not\in b$
is an external locus of $v$ iff it is a least ancestor of $v_o$
outside of $b$. That is, $\under{H}{v_o \preceq v}$, and there does
not exist a $v_o' \not\in b$ such that $\under{H}{v_o' \preceq v}$ and
$\under{H}{v_o \preceq v_o'}$. We lift the definition to the level of
branches; $v_o$ is an external locus of a branch $b$ iff it is an
external locus of its latest version.
\end{definition}

Note that all branches (except $H(t_{\top})$) begin with a \C{FORK}
tag, hence every version has at least one external locus. We later
prove that in the histories generated by the rules in
Fig.~\ref{fig:opsem}, each version (hence, each branch) has exactly
one external locus.

\begin{definition} [\bfseries Mergeability]
Given a history $H$, a version $v_1$ and a version $v_2$ that is not
an ancestor of $v_1$ under $H$, $v_2$ is mergeable into $v_1$ (denoted
$\under{H}{v_2 \mbleto v_1}$) iff $v_1$'s external locus is an
ancestor of $v_2$.
\end{definition}

\begin{lemma} [\bfseries Unique External Locus]
Every version $v$ (except the \C{INIT} version) in the history $H$
generated by the rules in Fig.~\ref{fig:opsem} has a unique external
locus.
\end{lemma}
\begin{proof}
By case analysis on the reduction relation. In each case, we assume
that the unique external locus property holds for the initial history,
and prove that it holds for the final history.

In \rulelabel{E-Run} case, initial version is the external locus of
the new version on the new branch $H(t)$. In \rulelabel{E-Fork} case,
which creates the branch $H(t')$ by forking from $H(t)$, the latest
version on $H(t)$ is the external locus of the first version on
$H(t)$. In \rulelabel{E-Push} case, the version on $H(t)$ has the same
external locus as the previous latest version, which, premise says, is
unique. No new version is created in \rulelabel{E-Pull}. In
\rulelabel{E-Pull-Wait}, new version is created by merging the latest
version ($v'$) on $H(t')$ into the latest version $v$ on $H(t)$.
Premise says that $v$ has a unique external locus (call it $v_o$). The
new version $v_m$ inherits $v_o$ as an external locus, and also has
$v'$ as another external locus. However, since $\under{H}{v' \mbleto
v}$, we have $\under{H}{v_o \preceq v'}$. Hence $v'$ is the only
external locus.
\qed
\end{proof}

\begin{theorem} [\bfseries Unique LCA]
Every pair of versions $v_1$ and $v_2$ in the history $H$ generated by
the rules in Fig.~\ref{fig:opsem} have a unique least
common ancestor. 
\end{theorem}
\begin{proof}
By case analysis on the step relation. In each case, we assume that
the unique LCA property holds for the initial history, and prove that
it holds for the final history.

The \rulelabel{E-Run} case is trivial. The \rulelabel{E-Push} case
creates a new version ($v$) with \C{PUSH} tag at the end of a branch.
Let $v_1$ be the previous version on the branch, and let $v_2$ be any
other version. The premise is that $v_1$ and $v_2$ have a unique LCA
$v_0$. Observe that if $v_0 \neq v_1$, then LCA of $v$ and $v_2$ must
also be an LCA of $v_1$ and $v_2$, hence LCA of $v$ and $v_2$ is
unique. If $v_0 = v_1$, then LCA of $v$ and $v_2$ is $v_1$, hence
unique. Thus, uniqueness of LCA is preserved. The reasoning for
\rulelabel{E-Fork} is similar. The \rulelabel{E-Pull} case is trivial. 

The \rulelabel{E-Pull-Wait} case is where the merge happens. 
\end{proof}

